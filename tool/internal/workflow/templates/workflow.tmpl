# GENERATED FILE, DO NOT MODIFY!
#
# To update this file please edit the manifest and run:
#   go run tool/main.go generate workflow -o .github/workflows/dockerfiles.yaml
#
name: Build Docker Images

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]
  schedule:
    # Run daily at 12 PM UTC (8 AM EDT / 7 AM EST)
    - cron: '0 12 * * *'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

permissions:
  checks: read
  statuses: read
  contents: read
  id-token: write
  packages: write

jobs:
  wait-for-ci:
    name: Wait for CI to pass
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI workflow
        uses: lewagon/wait-on-check-action@3603e826ee561ea102b58accb5ea55a1a7482343 # v1.4.1
        with:
          ref: ${{`{{ github.event.pull_request.head.sha || github.sha }}`}}
          check-name: 'Verify Generated Files'
          repo-token: ${{`{{ secrets.GITHUB_TOKEN }}`}}
          wait-interval: 10
{{ range .Jobs}}
  {{.ID}}:
    name: "{{.Name}}"
    runs-on: ubuntu-latest
    {{- if .Needs}}
    needs: [wait-for-ci, {{range $i, $need := .Needs}}{{if $i}}, {{end}}{{$need}}{{end}}]
    {{- else}}
    needs: [wait-for-ci]
    {{- end}}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Build {{.ImageName}}:{{.Version}}
        uses: ./.github/actions/dockerfile
        with:
          dockerfile_path: {{.DockerfilePath}}
          image_name: {{.ImageName}}
          image_tag: {{.Version}}
          registry: ${{`{{ env.REGISTRY }}`}}
          registry_username: ${{`{{ github.actor }}`}}
          registry_password: ${{`{{ secrets.GITHUB_TOKEN }}`}}
          image_repository: ${{`{{ env.REGISTRY }}`}}/${{`{{ github.repository_owner }}`}}
          push: ${{`{{ (github.event_name == 'push' || github.event_name == 'schedule') && github.ref == 'refs/heads/master' }}`}}
{{ end }}
  notify:
    needs: [{{range $i, $job := .Jobs}}{{if $i}}, {{end}}{{$job.ID}}{{end}}]
    if: always() && (github.event_name == 'push' || github.event_name == 'schedule') && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Notify on success
        if: ${{`{{ !contains(needs.*.result, 'failure') }}`}}
        run: |
          echo "✅ Docker image build completed successfully"
          # Add Slack notification here if needed

      - name: Notify on failure
        if: ${{`{{ contains(needs.*.result, 'failure') }}`}}
        run: |
          echo "❌ Docker image build failed"
          # Add Slack notification here if needed
          exit 1
